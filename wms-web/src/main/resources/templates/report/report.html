<!DOCTYPE html>
<html>
<head>
    <title wms:text="${web.label.report}">报表</title>
    <head th:replace="common/head" />
    <style>
    	#uploadReportContent input{
    		width: 300px;
    	}
    	#uploadReportContent td{
    		height: 50px;
    		text-align: center;
    	}
    </style>
</head>
<body class="easyui-layout" >
	<div data-options="region:'center',border:false" >
		<div class="tableToolbar">
			<a href="#" class="easyui-linkbutton" onclick="upload()">
				<span wms:text="${web.label.upload}">upload</span>
			</a>
		</div>
		<div>
			<table id="tableData"  wms:title="${web.label.files}" class="easyui-datagrid" >
				<thead>
					<tr>
						<th field="fileId" width="80" data-options="checkbox:true">fileId</th>
						<th field="code" width="80" wms:text="${web.label.code}" data-options="sortable:true">code</th>
			            <th field="descr" width="130" wms:text="${web.label.descr}"
			                data-options="sortable:true">descr
			            </th>
						<th field="fileName" width="250" wms:text="${web.label.filename}" data-options="sortable:true">fileName</th>
						<th field="download" wms:text="${web.label.download}" data-options="
											formatter:function(value,row){
												var fileId = row.fileId;
												var detail = '<span title = \'download\' onclick=downloadReport(\''+fileId+'\') class=\'icon-detail\'>&nbsp;</span>';
												if (fileId == null || fileId == '' || fileId == undefined){
													detail = '';
												}
												return detail;
											}
										"></th>
						<th field="updateBy" width="80" wms:text="${web.label.updateby}" >updateBy</th>
						<th field="updateTime" width="150" wms:text="${web.label.updatetime}" data-options="sortable:true">updateTime</th>
					</tr>
				</thead>
			</table>
		</div>
	</div>
	<div id="uploadReportContent" style="display: none;" wms:title="${web.label.upload}">
		<form id="uploadReportForm" enctype="multipart/form-data">
			<table>
				<tr>
					<td>
						 <input class="easyui-combobox"  name="template" id="template" wms:data-options="
							required:true,
							data: codelkups['REPORT'],
							valueField: 'code',
							textField: 'descr',
							label: '${web.label.report}',
							labelPosition: 'top'
							"/>
					</td>
				</tr>
				<tr>
					<td>
						<input id="file" name="file" class="easyui-filebox" wms:data-options="required:true,label:'${web.label.files}',labelPosition:'top'" />
					</td>
				</tr>
				<tr>
					<td>
						<a href="#" class="easyui-linkbutton" id="uploadVersion" onclick="uploadReport()" wms:text="${web.label.upload}" data-form="#uploadReportForm" data-options="iconCls:'icon-ok'">Save</a>
						<a href="#" class="easyui-linkbutton" id="clearForm" onclick="$('#uploadReportForm').form('clear');" wms:text="${web.label.clear}" data-options="iconCls:'icon-clear'">Clear</a>
					</td>
				</tr>
			</table>
		</form>
	</div>
</body>
<script th:replace="common/js" />
<script type="text/javascript" th:src="@{/js/codelkupList?listName=REPORT}"></script>
<script type="text/javascript">
/**
 * 打开上传弹出框
 */
function upload(obj){
	$("#uploadReportForm").form('clear');
	$('#uploadReportContent').dialog({
	    closed: true,
	    modal: true,
	    fix: true
	}).dialog('open');
}

$(function(){
	search();
});

/**
 * 表格数据加载
 */
function search(){
	$('#tableData').datagrid({
		url: getServiceUrl() + '/services/inner/file/find',
		pagination:true,
		queryParams: {
			fileType:"MOBILE"
		}
	}).datagrid('clearChecked');
	$('#tableData').datagrid({
		url: getServiceUrl() + '/services/inner/report/find'
	});
}

function downloadReport(fileId){
	var d = new Date();
	var url = getFileUrl() + '/file/download?v='+d.getTime();
	url = url + "&warehouseId=0&companyId=0&fileId=" + fileId
	window.open(url);
}

/**
 * 上传文件
 */
function uploadReport(){
	loading();
	var data = new FormData($("#uploadReportForm")[0]);
	var baseData = getBaseData();
	baseData['warehouseId'] = 0;
	baseData['companyId'] = 0;
	var keys = Object.keys(baseData);
	keys.forEach(function(key){
		data.append(key,baseData[key]);
	})
	var url = getFileUrl() + '/file/uploadReport';
	loading();
	$.post({
		url: url,
		data:  data,
		processData: false,
        contentType: false,
        enctype: 'multipart/form-data',
		success: function(data){
			data = returnData(data);
			closeLoading();
			if (data.code == '0') {
				showError(data.msg);
				return;
			}
			showMsg($.locale.uploadSuccess,function(){
				$('#uploadReportContent').dialog('close');
				search();
			});
		},
		error: function (data) {
			closeLoading();
			showMsg("Request failed!");
		}
	});
}
</script>
</html>
